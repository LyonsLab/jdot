function MultiDotPlot(a,b){mixInto(this,Syndicator,"subscribe","unsubscribe","publish","routes"),this.constructor=function(){if(this.element=document.getElementById(a),!this.element)return void console.log("MultiDotPlot: error: id '"+a+"' not found");this.configure(b),this.config.genomes||console.log("MultiDotPlot: no genomes specified"),this.controller=new Controller;var c=this.config.genomes.length,d=15,e=b.size.width/c-d,f=b.size.height/c-d;this.dotplots=[];for(var g=0;c>g;g++)for(var h=0;c>h;h++){var i=createDiv(this.element,this.element.id+"_"+g+"_"+h),j=new DotPlot(i.id,{size:{width:e,height:f},genomes:[this.config.genomes[g],this.config.genomes[h]],fetchDataHandler:this.config.fetchDataHandler,controller:this.controller,disableRulers:!1,gridCol:g,gridRow:h,style:{left:g*e+"px",top:h*f+"px",position:"relative"}});this.dotplots.push(j)}this.controller.addListener("all",this.on.bind(this))},this.configure=function(a){this.config=a||{},this.config.size=this.config.size||{width:800,height:600},this.config.style&&applyStyles(this.element,this.config.style)},this.on=function(a,b){var c=this.plot.drawable,d={};switch(d.target=b.target,a){case"select_point":d.bounds=c.getBounds(b.x,b.y),this.publish("/multidotplot/select_point",d)}},this.redraw=function(){for(var a=0;a<this.dotplots;a++)this.dotplots[a].redraw()},this.constructor()}function DotPlot(a,b){mixInto(this,Syndicator,"subscribe","unsubscribe","publish","routes"),this.constructor=function(){if(this.element=document.getElementById(a),!this.element)return void console.log("DotPlot: error: id '"+a+"' not found");this.configure(b),this.controller=this.config.controller||new Controller;var c=b.disableRulers?0:75,d=b.size.width-c,e=b.size.height-c,f=b.genomes[0],g=b.genomes[1];this.plot=new Plot(createCanvas(this.element,"plot"+generateID()),{size:{width:d,height:e},extent:{width:f.length,height:g.length},labels:{x:f.chromosomes,y:g.chromosomes},scaled:!0,crosshairs:!0,fetchDataHandler:b.fetchDataHandler,style:{left:c+"px",top:c+"px",position:"absolute"}}),this.controller.addListener(this.plot.drawable),b.disableRulers||(this.config.gridRow&&0!==this.config.gridRow||(this.xrule=new Rule(createCanvas(this.element,"xrule"+generateID()),{size:{width:d,height:c},extent:{width:f.length,height:g.length},orientation:"horizontal",direction:"increasing",scaled:!1,title:this.config.gridRow&&0!==this.config.gridRow?"":f.name,labels:f.chromosomes,style:{left:c+"px",top:"0px",position:"absolute"}}),this.controller.addListener(this.xrule.drawable)),this.config.gridCol&&0!==this.config.gridCol||(this.yrule=new Rule(createCanvas(this.element,"yrule"+generateID()),{size:{width:c,height:e},extent:{width:f.length,height:g.length},orientation:"vertical",direction:"northwest"===this.config.origin?"increasing":"decreasing",scaled:!1,title:this.config.gridCol&&0!==this.config.gridCol?"":g.name,labels:g.chromosomes,style:{left:"0px",top:c+"px",position:"absolute"}}),this.controller.addListener("all",this.on.bind(this)),this.controller.addListener(this.yrule.drawable)))},this.on=function(a,b){var c=this.plot.drawable,d={};switch(d.target=b.target,a){case"select_point":d.bounds=c.getBounds(b.x,b.y),this.publish("/dotplot/select_point",d)}},this.configure=function(a){return this.config=a||{},this.config.genomes?(this.config.size=this.config.size||{width:800,height:600},void(this.config.style&&applyStyles(this.element,this.config.style))):void console.log("Error: no genomes")},this.redraw=function(){this.plot.redraw(),this.xrule&&this.xrule.redraw(),this.yrule&&this.yrule.redraw()},this.reset=function(){this.plot.zoom(0,0,0),this.xrule.zoom(0,0,0),this.yrule.zoom(0,0,0)},this.constructor()}function Controller(a,b){this.constructor=function(){this.config=b||{},this.config.zoomSpeed=this.config.zoomSpeed||1e3,this.config.dragSpeed=this.config.dragSpeed||10,this.mouse={target:void 0,isDown:!1,drag:{x:0,y:0}};var c=this;document.onmousedown=function(a){this.onmousedown.call(c,a)},document.onmouseup=function(a){this.onmouseup.call(c,a)},document.onmousemove=function(a){this.onmousemove.call(c,a)},document.onclick=function(a){this.onclick.call(c,a)},this.drawables=a||[],this.drawables.forEach(function(a){a&&(a.element.onmousewheel=function(a){this.onmousewheel.call(c,a)})}),document.onkeydown=function(a){this.onkeydown.call(c,a)}},this.addListener=function(a,b){var c=this;if("[object Object]"===toString.apply(a))a.element.onmousewheel=function(a){this.onmousewheel.call(c,a)},this.drawables.push(a);else{var d={};d[a]=b,this.drawables.push(d)}},this._getDrawableById=function(a){var b;return this.drawables.some(function(c){return c.element&&c.element.id===a?(b=c,!0):void 0}),b},this.onkeydown=function(a){var b=0,c=0;switch(a.keyCode){case 37:b=5,c=0;break;case 38:b=0,c=5;break;case 39:b=-5,c=0;break;case 40:b=0,c=-5}this.drawables.forEach(function(a){a.drag&&"both"===a.config.orientation&&a.drag(b,c)})},this.onmousewheel=function(a){var b=a.target.getBoundingClientRect(),c=a.x-b.left,d=a.y-b.top,e=a.wheelDelta/this.config.zoomSpeed,f=Math.pow(1+Math.abs(e)/2,e>0?1:-1),g=this._getDrawableById(a.target.id);g&&(this.drawables.forEach(function(a){!a.zoom||a.config.orientation!==g.config.orientation&&"both"!==a.config.orientation&&"both"!==g.config.orientation||a.zoom(c,d,f,g.config.orientation)}),a.preventDefault())},this.onmousedown=function(a){if(!this.mouse.target||a.target===this.mouse.target){this.mouse.target=a.target;var b=a.target.getBoundingClientRect();this.mouse.drag.x=a.x-b.left,this.mouse.drag.y=a.y-b.top,this.mouse.isDown=!0,this.mouse.shiftKey=a.shiftKey}},this.onmousemove=function(a){var b,c,d;return this.mouse.isDown?this.onmousedrag(a):(b=a.srcElement.getBoundingClientRect(),c=a.x-b.left,d=a.y-b.top,void this.drawables.forEach(function(b){b.hover&&b.element===a.srcElement&&b.hover(c,d)}))},this.onmousedrag=function(a){if(this.mouse.target){var b=this.mouse.target.getBoundingClientRect(),c=a.x-b.left,d=a.y-b.top,e=this._getDrawableById(this.mouse.target.id);if(e)if(this.mouse.shiftKey){var f=this.mouse.drag.x,g=this.mouse.drag.y;e.highlight(c,d,f,g)}else{var h=(c-this.mouse.drag.x)/this.config.dragSpeed,i=(d-this.mouse.drag.y)/this.config.dragSpeed;"horizontal"===e.config.orientation?i=0:"vertical"===e.config.orientation&&(h=0),this.drawables.forEach(function(a){!a.drag||a.config.orientation!==e.config.orientation&&"both"!==a.config.orientation&&"both"!==e.config.orientation||a.drag(h,i)})}}},this.onclick=function(a){var b,c,d;b=a.target.getBoundingClientRect(),c=a.x-b.left,d=a.y-b.top,this.drawables.forEach(function(b){b.select_point&&a.target===b.element&&b.select_point(c,d),b.all&&b.all("select_point",{target:a.target,x:c,y:d})})},this.onmouseup=function(a){var b=this.mouse.isDown;if(this.mouse.isDown=!1,this.mouse.target){var c=this.mouse.target;this.mouse.target=null;var d=this._getDrawableById(c.id);if(d){var e=c.getBoundingClientRect();if(this.mouse.shiftKey&&b){var f=a.x-e.left,g=a.y-e.top,h=this.mouse.drag.x,i=this.mouse.drag.y;"horizontal"===d.config.orientation?(g=0,i=Number.MAX_VALUE):"vertical"===d.config.orientation&&(f=0,h=Number.MAX_VALUE),this.drawables.forEach(function(a){!a.select||a.config.orientation!==d.config.orientation&&"both"!==a.config.orientation&&"both"!==d.config.orientation||a.select(f,g,h,i)})}}}},this.constructor()}function Drawable(a,b){this.configure=function(a){this.config=a||{},this.selectionBuffer,this.config.size=this.config.size||{width:800,height:50},this.config.crosshairs&&(this.crosshairs=new Crosshairs),this.config.orientation=this.config.orientation||"both"},this.constructor=function(){this.element=a,this.configure(b),this.element.width=this.config.size.width,this.element.height=this.config.size.height,this.context=a.getContext("2d"),this.origin={x:0,y:0},this.extent={width:this.config.extent.width,height:this.config.extent.height},this.view={width:this.config.extent.width,height:this.config.extent.height},this.scale={x:this.config.size.width/this.config.extent.width,y:this.config.size.height/this.config.extent.height},this.config.scaled&&this.context.scale(this.scale.x,this.scale.y)},this.setRenderer=function(a,b){this.renderer=b,this.scope=a},this.setSize=function(a,b){this.element.width=a,this.element.height=b},this.clear=function(){this.context.clearRect(0,0,this.config.extent.width,this.config.extent.height)},this.redraw=function(){this.clear(),this.renderer.call(this.scope)},this.highlight=function(a,b,c,d){a=constrainTo(a,0,this.config.size.width-1),b=constrainTo(b,0,this.config.size.height-1),c=constrainTo(c,0,this.config.size.width-1),d=constrainTo(d,0,this.config.size.height-1);var e=Math.min(a,c),f=Math.min(b,d),g=Math.abs(a-c)+1,h=Math.abs(b-d)+1;this.crosshairs&&this.crosshairs.clear(this),this.config.orientation&&"both"!==this.config.orientation?"horizontal"===this.config.orientation?(restoreSelection(this.context,e,0),saveSelection(this.context,e,0,g,this.config.size.height-1,.1),drawRect(this.context,e,0,g,this.config.size.height-1,.1)):"vertical"===this.config.orientation&&(restoreSelection(this.context,0,f),saveSelection(this.context,0,f,this.config.size.width-1,h,.1),drawRect(this.context,0,f,this.config.size.width-1,h,.1)):(restoreSelection(this.context),saveSelection(this.context,e,f,g,h),drawRect(this.context,e,f,g,h,.1))},this.select=function(a,b,c,d){a=constrainTo(a,0,this.config.size.width-1),b=constrainTo(b,0,this.config.size.height-1),c=constrainTo(c,0,this.config.size.width-1),d=constrainTo(d,0,this.config.size.height-1);var e=Math.min(a,c),f=Math.min(b,d),g=Math.abs(a-c)+1,h=Math.abs(b-d)+1;if(0!==g&&0!==h){var i=this.origin.x+e/this.scale.x,j=this.origin.y+f/this.scale.y;this.view.width=g/this.scale.x,this.view.height=h/this.scale.y;var k=this.config.size.width/this.view.width,l=this.config.size.height/this.view.height,m=k/this.scale.x,n=l/this.scale.y;this.scale.x=k,this.scale.y=l,this.config.scaled&&(this.context.translate(this.origin.x,this.origin.y),this.context.scale(m,n),this.context.translate(-i,-j)),this.origin.x=i,this.origin.y=j,clearSelection(),this.redraw()}},this.select_point=function(a,b){var c=[],d=this.origin.x+(a-1)/this.scale.x,e=this.origin.y+(b-1)/this.scale.y,f=this.origin.x+(a+1)/this.scale.x,g=this.origin.y+(b+1)/this.scale.y;c.push([d,e]),c.push([d,g]),c.push([f,e]),c.push([f,g])},this.zoom=function(a,b,c,d){this.crosshairs&&this.crosshairs.clear(this);var e,f;e=f=c;var g=this.config.size.width/this.extent.width,h=this.scale.x*c;g>h&&(h=g,e=h/this.scale.x);var i=this.config.size.height/this.extent.height,j=this.scale.y*c;i>j&&(j=i,f=j/this.scale.y),"horizontal"===d?(f=1,j=this.scale.y):"vertical"===d&&(e=1,h=this.scale.x);var k=a/this.scale.x+this.origin.x-a/h,l=b/this.scale.y+this.origin.y-b/j;this.scale.x=h,this.scale.y=j,this.view.width=this.config.size.width/this.scale.x,this.view.height=this.config.size.height/this.scale.y,this.config.scaled&&(0>k?k=0:k+this.view.width>=this.extent.width&&(k=this.extent.width-this.view.width),0>l?l=0:l+this.view.height>=this.extent.height&&(l=this.extent.height-this.view.height),this.context.translate(this.origin.x,this.origin.y),this.context.scale(e,f),this.context.translate(-k,-l)),this.origin.x=k,this.origin.y=l,this.config.scaled||(this.origin.x<0?(this.view.width+=this.origin.x,this.origin.x=0):this.origin.x+this.view.width>=this.extent.width&&(this.origin.x=this.extent.width-this.view.width),this.origin.y<0?(this.view.height+=this.origin.y,this.origin.y=0):this.origin.y+this.view.height>=this.extent.height&&(this.origin.y=this.extent.height-this.view.height)),this.redraw()},this.hover=function(a,b){this.crosshairs&&this.crosshairs.redraw(this,a,b)},this.drag=function(a,b){this.crosshairs&&this.crosshairs.clear(this),this.isMinScale()||(a/=this.scale.x,b/=this.scale.y,this.translate(a,b),this.redraw())},this.translate=function(a,b){this.origin.x-a<0?a=this.origin.x:this.origin.x+this.view.width-a>=this.config.extent.width&&(a=this.origin.x+this.view.width-this.config.extent.width),this.origin.y-b<0?b=this.origin.y:this.origin.y+this.view.height-b>=this.config.extent.height&&(b=this.origin.y+this.view.height-this.config.extent.height),this.config.scaled&&this.context.translate(a,b),this.origin.x-=a,this.origin.y-=b},this.isMinScale=function(){var a=this.config.size.width/this.config.extent.width,b=this.config.size.height/this.config.extent.height;return this.scale.x===a&&this.scale.y===b},this.getBounds=function(a,b,c,d){var e,f,g,h,i=this.origin,j=this.scale,k=[];return arguments.length>2?(e=i.x+a/j.x,f=i.x+c/j.x,g=i.y+b/j.y,h=i.y+d/j.y):(e=i.x+(a-1)/j.x,f=i.x+(a+1)/j.x,g=i.y+(b-1)/j.y,h=i.y+(b+1)/j.y),k.push([e,g]),k.push([e,h]),k.push([f,g]),k.push([f,h]),k},this.constructor()}function Crosshairs(a,b,c){this.constructor=function(){this.styles={colors:a||(a=[255,0,0]),alpha:c||(c=1),lineWidth:b||(b=1)},this.buffer=void 0},this._save=function(a,b,c,d,e){var f=this.styles.lineWidth;this.buffer={verticalBuffer:a.getImageData(b,0,f,e),horizontalBuffer:a.getImageData(0,c,d,f),previousX:b,previousY:c}},this._restore=function(a){var b=this.buffer;void 0!==b&&(a.putImageData(b.verticalBuffer,b.previousX,0),a.putImageData(b.horizontalBuffer,0,b.previousY),this.buffer=void 0)},this.clear=function(a){this._restore(a.context)},this.redraw=function(a,b,c){var d=a.context,e=a.config.size.width,f=a.config.size.height,g=this.styles.lineWidth,h=this.styles.alpha,i=this.styles.colors;this._restore(d),this._save(d,b,c,e,f),drawRect(d,b,0,g,f,h,i,!0),drawRect(d,0,c,e,g,h,i,!0)},this.constructor()}function Rule(a,b){this.constructor=function(){this.element=a,this.configure(b),this.drawable=new Drawable(a,b),this.drawable.setRenderer(this,this.redraw)},this.configure=function(a){this.config=a||{},this.config.orientation=this.config.orientation||"horizontal",this.config.direction=this.config.direction||"increasing",this.config.titleFontName=this.config.titleFontName||"Arial",this.config.titleFontSize=this.config.titleFontSize||12,this.config.labelFontName=this.config.labelFontName||"Arial",this.config.labelFontSize=this.config.labelFontSize||10,this.config.tickFontName=this.config.tickFontName||"Arial",this.config.tickFontSize=this.config.tickFontSize||6;var b="increasing"===this.config.direction;if(this.config.labels){this.labels=[];var c;c=b?0:this.config.labels.reduce(function(a,b){return{length:a.length+b.length}}).length;for(var d=0;d<this.config.labels.length;d++){var e=this.config.labels[d],f=e.length/2;b||(f*=-1),c+=f,this.labels.push({pos:c,text:e.name}),c+=f}}this.config.style&&applyStyles(this.element,this.config.style)},this.zoom=function(a,b,c,d){this.drawable.zoom(a,b,c,d)},this.highlight=function(a,b,c,d){this.drawable.highlight(a,b,c,d)},this.select=function(a,b,c,d){this.drawable.select(a,b,c,d)},this.drag=function(a,b){this.drawable.drag(a,b)},this.drawTick=function(b){var c=this.drawable.context,d=("horizontal"===this.config.orientation?this.scale.x:this.scale.y,this.scale*b);c.beginPath(),c.moveTo(d,a.height-11),c.lineTo(d,a.height),c.stroke(),drawText(c,toUnits(b),d,a.height-13,{rotate:45,font:"6pt Arial"})},this.redraw=function(){var b,c=this.drawable.context;this.drawable.clear();var d=this.config.titleFontSize+"pt "+this.config.titleFontName;this.config.title&&("horizontal"===this.config.orientation?drawText(c,this.config.title,a.width/2,14,{align:"center",font:d}):drawText(c,this.config.title,14,a.height/2,{rotate:90,font:d})),d=this.config.tickFontSize+"pt "+this.config.tickFontName,c.lineWidth=.2;var e,f,g,h;"horizontal"===this.config.orientation?(e=this.config.size.width,guLength=this.config.extent.width,f=this.drawable.origin.x,g=this.drawable.view.width,h=this.drawable.scale.x):(e=this.config.size.height,guLength=this.config.extent.height,f=this.drawable.origin.y,g=this.drawable.view.height,h=this.drawable.scale.y);var i=roundBase10(g/10),j=roundBase10(f)+i,k=h+int(i*h),l=int(guLength/i)-1;for("decreasing"===this.config.direction&&(k=guLength*h-k,i*=-1),b=k,guPos=j;l>0;l--,b+=i*h,guPos+=Math.abs(i))"horizontal"===this.config.orientation?(drawLine(c,b,a.height-11,b,a.height),drawText(c,toUnits(guPos),b,a.height-13,{rotate:45,font:d})):(drawLine(c,a.width-11,b,a.width,b),drawText(c,toUnits(guPos),a.width-32,b+20,{rotate:45,font:d}));if(d="bold "+this.config.labelFontSize+"pt "+this.config.labelFontName,this.labels)for(var m=0;m<this.labels.length;m++){var n=this.labels[m];b=int((n.pos-f)*h),b>=0&&e>=b&&("horizontal"===this.config.orientation?drawText(c,n.text,b,a.height-2,{align:"center",rotate:0,font:d}):drawText(c,n.text,a.width-7,b+3,{align:"right",rotate:0,font:d}))}},this.constructor(),this.drawable.redraw()}function Plot(a,b){this.constructor=function(){return this.element=a,this.element?(this.configure(b),this.drawable=new Drawable(a,b),this.setFetch(b.fetchDataHandler),void this.drawable.setRenderer(this,this.render)):void console.log("Plot: error: id '"+id+"' not found")},this.configure=function(a){this.config=a||{},this.config.style&&applyStyles(this.element,this.config.style),this.config.origin=this.config.origin||"southwest"},this.drawLabels=function(){var a=this.drawable.context;a.lineWidth=1/this.drawable.scale.x/2;for(var b=this.config.labels.x,c=0,d=0;c<b.length-1;c++)d+=b[c].length,drawLine(a,d,1,d,this.config.extent.height-1);for(b=this.config.labels.y,a.lineWidth=1/this.drawable.scale.y/2,c=0,y=0;c<b.length-1;c++){y+=b[c].length;var e=y;"southwest"===this.config.origin&&(e=this.config.extent.height-y),drawLine(a,1,e,this.config.extent.width-1,e)}},this.drawDots=function(a){if(a)for(var b=this.drawable.context,c="southwest"===this.config.origin,d=this.config.extent.height,e=0;e<a.length;e++){var f=a[e].y;c&&(f=d-f),b.fillRect(a[e].x,f,1e3,1e3)}},this.drawLines=function(a){if(a)for(var b=this.drawable.context,c=Math.max(this.drawable.scale.x,this.drawable.scale.y),d="southwest"===this.config.origin,e=this.config.extent.height,f=0;f<a.length;f++){var g=a[f].y1,h=a[f].y2;d&&(g=e-g,h=e-h),a[f].color&&(b.strokeStyle=a[f].color),b.lineWidth=1/c,b.beginPath(),b.moveTo(a[f].x1,g),b.lineTo(a[f].x2,h),b.stroke()}},this.drawRects=function(a){if(a)for(var b,c,d,e,f=this.drawable.context,g=Math.max(this.drawable.scale.x,this.drawable.scale.y),h="southwest"===this.config.origin,i=this.config.extent.height,j=0;j<a.length;j++)b=a[j][0],c=a[j][1],d=a[j][2],e=a[j][3],h&&(c=i-c,e*=-1),f.lineWidth=2/g,f.strokeRect(b,c,d,e)},this.drawBorder=function(){drawScaledRect(this.drawable.context,0,0,this.config.extent.width,this.config.extent.height,this.drawable.scale.x,this.drawable.scale.y)},this.render=function(){if(!this.fetch)return void console.log("Plot: no fetch handler");var a=this.fetch(this.drawable.origin.x,this.drawable.origin.y,this.drawable.view.width,this.drawable.view.height);this.drawLabels();for(var b=0;b<a.length;b++)this.drawable.context.save(),applyProperties(this.drawable.context,a[b].style),this.drawDots(a[b].points),this.drawLines(a[b].lines),this.drawRects(a[b].rects),this.drawable.context.restore();this.drawBorder()},this.redraw=function(){this.drawable.redraw()},this.highlight=function(a,b,c,d){this.drawable.highlight(a,b,c,d)},this.select=function(a,b,c,d){this.drawable.select(a,b,c,d)},this.hover=function(a,b){this.drawable.hover(a,b)},this.zoom=function(a,b,c,d){this.drawable.zoom(a,b,c,d)},this.drag=function(a,b){this.drawable.drag(a,b)},this.setFetch=function(a){this.fetch=a},this.constructor(),this.drawable.redraw()}function toUnits(a){var b=1e3,c=["","K","M","G","T"];if(0===a)return"0";var d=parseInt(Math.floor(Math.log(a)/Math.log(b)),10),e=4;return(a/Math.pow(b,d)).toPrecision(e)+" "+c[d]}function commify(){}function log10(a){return Math.log(a)/Math.log(10)}function roundPow10(a){return Math.pow(10,Math.ceil(log10(a)))}function roundBase10(a){if(0===a)return 0;var b=Math.pow(10,Math.floor(log10(a+1)));return Math.round(a/b)*b}function int(a){return Math.floor(a)}function drawLine(a,b,c,d,e,f){f&&(a.lineWidth=f),a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function drawScaledRect(a,b,c,d,e,f,g){a.lineWidth=1/f,drawLine(a,b,c,d,c),drawLine(a,b,e,d,e),a.lineWidth=1/g,drawLine(a,b,c+1,b,e-1),drawLine(a,d,c+1,d,e-1)}function restoreSelection(a){if(void 0!==this.selectionBuffer){var b=this.selectionBuffer[0],c=this.selectionBuffer[1];a.putImageData(this.selectionBuffer[2],b,c),this.selectionBuffer=void 0}}function saveSelection(a,b,c,d,e){this.selectionBuffer=[b,c,a.getImageData(b,c,d,e)]}function clearSelection(){this.selectionBuffer=void 0}function drawRect(a,b,c,d,e,f,g,h){"undefined"==typeof f&&(f=1);for(var i=a.getImageData(parseInt(b,10),parseInt(c,10),d,e),j=0,k=0;d*e>j;j++,k+=4)i.data[k+3]=!h&&(d>j||j>d*(e-1)||j%d===0||j%d===d-1)?60:Math.max(i.data[k+3],255*f),g&&(i.data[k]=g[0],i.data[k+1]=g[1],i.data[k+2]=g[2]);a.putImageData(i,b,c)}function drawText(a,b,c,d,e){if(a.save(),e&&(e.align||e.valign)){var f=a.measureText(b);"center"===e.align?c-=f.width/2:"right"===e.align&&(c-=f.width+1)}a.translate(c,d),e&&e.rotate&&a.rotate(-2*Math.PI*(e.rotate/365)),e&&e.font&&(a.font=e.font),a.fillText(b,0,0),a.restore()}function measureText(a,b,c,d){var e,f=a+":"+b+":"+c+":"+d;if("object"==typeof __measuretext_cache__&&__measuretext_cache__[f])return __measuretext_cache__[f];var g=document.createElement("DIV");return g.innerHTML=a,g.style.position="absolute",g.style.top="-100px",g.style.left="-100px",g.style.fontFamily=c,g.style.fontWeight=b?"bold":"normal",g.style.fontSize=d+"pt",document.body.appendChild(g),e=[g.offsetWidth,g.offsetHeight],document.body.removeChild(g),"object"!=typeof __measuretext_cache__&&(__measuretext_cache__=[]),__measuretext_cache__[f]=e,e}function mixInto(a,b){var c=slice.apply(arguments);if(a=c.shift(),b=c.shift(),c.length)for(var d=0;d<c.length;d++)b.hasOwnProperty(c[d])&&(a[c[d]]=b[c[d]]);else for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e])}function applyProperties(a,b){for(var c in b)a[c]=b[c]}function applyStyles(a,b){applyProperties(a.style,b)}function createCanvas(a,b){var c=document.createElement("canvas");return c.innerHTML="Oops ... your web browser does not support HTML5!",b&&(c.id=b),a||(a=document.body),a.appendChild(c),c}function createDiv(a,b){var c=document.createElement("div");return b&&(c.id=b),a||(a=document.body),a.appendChild(c),c}function constrainTo(a,b,c){return b>=a?b:a>=c?c:a}function generateID(){return id++}var Syndicator={routes:{},subscribe:function(a,b){var c=this.routes[a]||(this.routes[a]=[]);"function"==typeof b&&c.push(b)},unsubscribe:function(a,b){var c=this.routes[a]||(this.routes[a]=[]);c.forEach(function(a,d){b===a&&c.splice(d,1)})},publish:function(a){var b,c;b=slice.apply(arguments),a=b.shift(),c=this.routes[a]||[],c.length&&c.forEach(function(a){a.apply(a,b)})}},id=1,slice=Array.prototype.slice,toString=Object.prototype.toString;