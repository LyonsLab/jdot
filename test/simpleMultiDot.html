<html>
<body>

<div id="multidotplot"></div>

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script src="../src/dotplot2.js"></script>
<script src="../src/synmap.js"></script>

<script>

var dataURIs = [];
dataURIs[0] = "https://geco.iplantcollaborative.org/CoGe/data/diags/7113/7114/html/master_7113_7114.CDS-CDS.last.tdd10.cs0.filtered.dag.all.go_D20_g10_A5.aligncoords.gcoords.json";
dataURIs[1] = "https://geco.iplantcollaborative.org/CoGe/data/diags/7113/7118/html/master_7113_7118.CDS-CDS.last.tdd10.cs0.filtered.dag.all.go_D20_g10_A5.aligncoords.gcoords.json";

var sortFunc = inverse(sortBy("name", compareAlphaNumeric));

var plotBuilder = coge.synmap.PlotBuilder();

var layerData, layerObjects, reference, source, plotData, data, multidotplot;

var dataArray = [];
var genomesObj = {};

function parseData(json) {
    console.info("Called parseData");

    // Hacky way of getting the reference and source IDs
    layerData = _.values(json.layers)[0].data;
    layerObjects = _.values(layerData)[0];
    xAxis = reference = _.keys(layerObjects)[0];
    yAxis = source = _.keys(layerObjects[reference])[0];
    
    plotBuilder.loadJSON(json); // axisMetric is "nucleotides" by default
    plotBuilder.setChromosomeSort(sortFunc);
    plotBuilder.setXAxis(reference);
    plotBuilder.setYAxis(source);

    plotData = plotBuilder.get();

    if ( ! _.isArray(dataArray[xAxis]) ) dataArray[xAxis] = [];

    dataArray[xAxis][yAxis] = plotData;

    if ( ! _.has(genomesObj, plotData.xid)) {
        genomesObj[plotData.xid] = {
            name: plotData.xtitle,
            length: plotData.xtotal,
            chromosomes: plotData.xlabels
        };
    }

    if ( ! _.has(genomesObj, plotData.yid)) {
        genomesObj[plotData.yid] = {
            name: plotData.ytitle,
            length: plotData.ytotal,
            chromosomes: plotData.ylabels
        };
    }

}

/**
 * AJAX Requests populate genomeObj and dataArray.
 */

var requests = dataURIs.map( function(uri) { return $.getJSON(uri, parseData); });
var defer = $.when.apply($, requests);

defer.done(function() {
    console.info("AJAX requests resolved."); 

    // Specify what to show
    genomesObj.xIds = [_.keys(genomesObj)[0]];
    genomesObj.yIds = [_.keys(genomesObj)[1], _.keys(genomesObj)[2]];

    console.log("genomesObj", genomesObj);

    multidotplot = new MultiDotPlot("multidotplot", {
        size: { width: 1000, height: 800 },
        genomes: genomesObj,
        fetchDataHandler: fetchHandler,
        style: {
            position: "relative"
        }
    });

    multidotplot.redraw;
})

/**
 * This function needs to return an array of objects with "lines," "rects," etc.
 * This is called for each plot. "xId" and "yId" will be bound prior to the call.
 */
fetchHandler = function(xId, yId) {

    if ( ! dataArray[xId]) {
        console.info("dataArray[" + xId + "]:", dataArray[xId]);
        return([]);
    } else if ( ! dataArray[xId][yId] ) {
        console.info("dataArray[" + xId + "][" + yId + "]:", dataArray[xId][yId]);
        return([]);
    } else {
        thisData = dataArray[xId][yId];
    }

    // TODO: More than just lines
    data = [{ lines: _.values( thisData.layers.syntenic_pairs.lines ) }];

    return(data);
}

</script>

</body>
</html>
